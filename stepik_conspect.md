**_сводка по всем операторам_**

# 1.1 отношения

верная последовательность команд:

```sql
SELECT 'столбцы или * для выбора всех столбцов; обязательно'

FROM 'таблица; обязательно'

WHERE 'условие/фильтрация, например, city = 'Moscow'; необязательно'

GROUP BY 'столбец, по которому хотим сгруппировать данные; необязательно'

HAVING 'условие/фильтрация на уровне сгруппированных данных; необязательно'

ORDER BY 'столбец, по которому хотим отсортировать вывод; необязательно'
```

![прмиер отошения](/images/table.jpg)

> - отношение – это структура данных целиком, набор записей (в обычном понимании – таблица) , в примере –это Сотрудник;
> - кортеж – это каждая строка , содержащая данные (более распространенный термин – запись ), например, <001, Борин С.А, 234-01-23, программист>, все кортежи в отношении должны быть различны;
> - мощность – число кортежей в таблице (проще говоря, число записей), в данном случае 3, мощность отношения может быть любой (от 0 до бесконечности), порядок следования кортежей - неважен;
> - атрибут – это столбец в таблице (более распространенный термин – поле ), в примере – Табельный номер, Фамилия И.О., Телефон, Должность)
> - размерность – это число атрибутов в таблице, в данном случае – 4; размерность отношения должна быть больше 0, порядок следования атрибутов существенен;
> - домен атрибута – это допустимые значения (неповторяющиеся), которые можно занести в поле , например для атрибута Должность домен – {инженер, программист}.

пример запроса на создание таблицы:

```sql
CREATE TABLE book (
    book_id INT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(25),
    author VARCHAR(30),
    price DECIMAL(8,2),
    amount INT
);
```

прмиер вставки в таблицу:

```sql
INSERT book (title, author, price, amount)
    VALUES ('Мастер и Маргарита', 'Булгаков М.А.', 670.99	, 3);
```

или :

```sql
INSERT book (title, author, price, amount)
VALUES ('Белая гвардия', 'Булгаков М.А.', 540.50, 5),
        ('Идиот',	'Достоевский Ф.М.', 	460.00, 10),
        ('Братья Карамазовы', 'Достоевский Ф.М.',799.01,	2 );
```

# 1.2 выборка данных

пример тобрать все данные из таблицы:

```sql
SELECT * FROM book;
```

прмиер Выбрать названия книг и их количества из таблицы book :

```sql
SELECT title, amount FROM book;
```

прмиер выбрать из таблицы с изменением названия столбцов

```sql
SELECT
    title AS Название,
    author AS Автор
FROM book;
```

пример Выборка данных с созданием вычисляемого столбца:

```sql
SELECT title,
    amount,
    amount * 1.65 AS pack
FROM book
```

**_математические функции_**:
| Функция | Описание | Пример |
|------ | ------- | ------|
|`CEILING(x)`| возвращает наименьшее целое число, большее или равное x (округляет до целого числа в большую сторону)|EILING(4.2)=5 CEILING(-5.8)=-5|
`ROUND(x, k)`|округляет значение **x** до **k** знаков после запятой, если **k** не указано – **x** округляется до целого|ROUND(4.361)=4 ROUND(5.86592,1)=5.9|
|`FLOOR(x)`|возвращает наибольшее целое число, меньшее или равное x (округляет до целого числа в меньшую сторону)| FLOOR(4.2)=4 FLOOR(-5.8)=-6|
|`POWER(x, y)`| возведение **x** в степень **y**|POWER(3,4)=81.0|
|`SQRT(x)` | квадратный корень из **x** | SQRT(4)=2.0 SQRT(2)=1.41...|
|`DEGREES(x)`|конвертирует значение **x** из радиан в градусы| DEGREES(3) = 171.8...|
|`RADIANS(x)`|конвертирует значение x из градусов в радианы|RADIANS(180)=3.14...|
|`ABS(x)`| модуль числа x| ABS(-1) = 1 ABS(1) = 1|
|`PI()`|pi = 3.1415926...|

пример использования округления:

```sql
SELECT title,
    price,
    ROUND((price*18/100)/(1+18/100),2) AS tax,
    ROUND(price/(1+18/100),2) AS price_tax
FROM book;
```

## Выборка данных, вычисляемые столбцы, логические функции

В SQL реализована возможность заносить в поле значение в зависимости от условия. Для этого используется функция IF

`IF(логическое_выражение, выражение_1, выражение_2)`

пример запроса:

```sql
SELECT title, amount, price,
    IF(amount<4, price*0.5, price*0.7) AS sale
FROM book;
```

прмиер вложенного IF запроса:

```sql
SELECT title, amount, price,
    ROUND(IF(amount < 4, price * 0.5, IF(amount < 11, price * 0.7, price * 0.9)), 2) AS sale,
    IF(amount < 4, 'скидка 50%', IF(amount < 11, 'скидка 30%', 'скидка 10%')) AS Ваша_скидка
FROM book;
```

## Выборка данных по условию

пример:

```sql
SELECT title, author, price * amount AS total
FROM book
WHERE price * amount > 4000;
```

## Выборка данных, логические операции

Приоритеты операций:

1. круглые скобки
2. умножение (\*), деление (/)
3. сложение (+), вычитание (-)
4. операторы сравнения (=, >, <, >=, <=, <>)
5. NOT
6. AND
7. OR

пример:

```SQL
SELECT title, author, price
FROM book
WHERE (author = 'Булгаков М.А.' OR author = 'Есенин С.А.') AND price > 600;
```

## операторы BETWEEN, IN

Логическое выражение после ключевого слова `WHERE` может включать операторы `BETWEEN` и `IN`.
Оператор `BETWEEN` позволяет отобрать данные, относящиеся к некоторому интервалу, включая его границы.

пример:

```sql
SELECT title, amount
FROM book
WHERE amount BETWEEN 5 AND 14;
```

## Сортировка | `ORDER BY`

По умолчанию `ORDER BY` выполняет сортировку по возрастанию. Чтобы управлять направлением сортировки вручную, после имени столбца указывается ключевое слово `ASC` (по возрастанию) или `DESC` (по убыванию).

пример:

```sql
SELECT author, title, amount AS Количество
FROM book
WHERE price < 750
ORDER BY author, amount DESC;
```

или другие варианты

```sql
SELECT author, title, amount AS Количество
FROM book
WHERE price < 750
ORDER BY author, Количество DESC;
```

```sql
SELECT author, title, amount AS Количество
FROM book
WHERE price < 750
ORDER BY 1, 3 DESC;
```

`Важно`! Если названия столбцов заключены в кавычки, то при использовании их в сортировке, необходимо записывать их БЕЗ КАВЫЧЕК.

## Оператор LIKE

Оператор `LIKE` используется для сравнения строк. В отличие от операторов отношения равно (=) и не равно (<>), `LIKE` позволяет сравнивать строки не на полное совпадение (не совпадение), а в соответствии с шаблоном. Шаблон может включать **обычные символы** и **символы-шаблоны**.

| Символ-шаблон | Описание                                         | Пример                                                                                                                                |
| ------------- | ------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------- |
| %             | Любая строка, содержащая ноль или более символов | `SELECT * FROM book WHERE author LIKE '%М.%'` выполняет поиск и выдает все книги, инициалы авторов которых содержат _«М.»_            |
| \_            | Любой одиночный символ                           | `SELECT * FROM book WHERE title LIKE 'Поэм_'` выполняет поиск и выдает все книги, названия которых либо «Поэма», либо _«Поэмы»_ и пр. |

Вывести названия книг, начинающихся с буквы «Б».

```sql
SELECT title
FROM book
WHERE title LIKE 'Б%';
/* эквивалентное условие
title LIKE 'б%'
*
```

пример Вывести название книг, состоящих ровно из 5 букв:

```sql
SELECT title FROM book
WHERE title LIKE "_____"
```

пример Вывести книги, название которых длиннее 5 символов:

```sql
SELECT title FROM book
WHERE title LIKE "______%";
/* эквивалентные условия
title LIKE "%______"
title LIKE "%______%"
*/
```

пример:

```sql
SELECT title FROM book
WHERE   title LIKE "_% и _%" /*отбирает слово И внутри названия */
    OR title LIKE "и _%" /*отбирает слово И в начале названия */
    OR title LIKE "_% и" /*отбирает слово И в конце названия */
    OR title LIKE "и" /* отбирает название, состоящее из одного слова И */
```

# 1.3 Запросы, групповые операции

## Выбор уникальных элементов столбца

Чтобы отобрать уникальные элементы некоторого столбца используется ключевое слово DISTINCT, которое размещается сразу после SELECT.
Пример Выбрать различных авторов, книги которых хранятся в таблице book:

```sql
SELECT DISTINCT author
FROM book;
```

Другой способ – использование оператора GROUP BY, который группирует данные при выборке, имеющие одинаковые значения в некотором столбце.

пример:

```sql
SELECT  author
FROM book
GROUP BY author;
```

## групповые функции SUM и COUNT

пример:

```sql
select
    author as  Автор,
    count(title) as Различных_книг,
    sum(amount) as Количество_экземпляров
from book
group by author;
```

## групповые функции MIN, MAX и AVG

`MIN()`, `MAX()` и `AVG()`, вычисляют минимальное, максимальное и среднее значение элементов столбца, относящихся к группе.

Пример:

```SQL
select
    author,
    min(price) as Минимальная_цена,
    max(price) as Максимальная_цена,
    avg(price) as Средняя_цена
from book
group by author;
```

## Выборка данных c вычислением, групповые функции

Пример Найти среднюю цену книг каждого автора.

```sql
SELECT author, ROUND(AVG(price),2) AS Средняя_цена
FROM book
GROUP BY author;
```

## Выборка данных по условию, групповые функции

В запросы с групповыми функциями можно включать условие отбора строк, записывается после `WHERE`. В запросах с групповыми функциями вместо `WHERE` используется ключевое слово `HAVING` , которое размещается после оператора `GROUP BY`.

пример:

```SQL
SELECT author,
    MIN(price) AS Минимальная_цена,
    MAX(price) AS Максимальная_цена
FROM book
GROUP BY author
HAVING SUM(price * amount) > 5000
ORDER BY Минимальная_цена DESC;
```

## Выборка данных по условию, групповые функции, WHERE и HAVING

`WHERE` и `HAVING` могут использоваться в одном запросе. При этом необходимо учитывать **порядок выполнения SQL запроса на выборку на СЕРВЕРЕ:**

1. FROM
2. WHERE
3. GROUP BY
4. HAVING
5. SELECT
6. ORDER BY

Сначала определяется таблица, из которой выбираются данные `FROM`, затем из этой таблицы отбираются записи в соответствии с условием `WHERE`, выбранные данные агрегируются `GROUP BY`, из агрегированных записей выбираются те, которые удовлетворяют условию после `HAVING`. Потом формируются данные результирующей выборки, как это указано после `SELECT` ( вычисляются выражения, присваиваются имена и пр. ). Результирующая выборка сортируется, как указано после `ORDER BY`.

Пример Вывести максимальную и минимальную цену книг каждого автора, кроме Есенина, количество экземпляров книг которого больше 10:

```sql
SELECT author,
    MIN(price) AS Минимальная_цена,
    MAX(price) AS Максимальная_цена
FROM book
WHERE author <> 'Есенин С.А.'
GROUP BY author
HAVING SUM(amount) > 10;
```

или решать так:

```sql
SELECT author,
    MIN(price) AS Минимальная_цена,
    MAX(price) AS Максимальная_цена
FROM book
GROUP BY author
HAVING SUM(amount) > 10 AND author <> 'Есенин С.А.';
```
